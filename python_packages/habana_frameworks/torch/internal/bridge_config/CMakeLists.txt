# ##############################################################################
# Copyright (C) 2023 Habana Labs, Ltd. an Intel Company
# All Rights Reserved.
#
# Unauthorized copying of this file or any element(s) within it, via any medium
# is strictly prohibited. This file contains Habana Labs, Ltd. proprietary and
# confidential information and is subject to the confidentiality and license
# agreements under which it was provided.
#
# ##############################################################################
cmake_minimum_required(VERSION 3.10 FATAL_ERROR)

set(TARGET_NAME "_bridge_config_C")
add_habana_library(${TARGET_NAME} SHARED
  # Autogenerated file
  ${CMAKE_BINARY_DIR}/generated/env_flags/Bindings.cpp)
target_compile_definitions(${TARGET_NAME} PRIVATE TORCH_EXTENSION_NAME=${TARGET_NAME})
set_target_properties(${TARGET_NAME} PROPERTIES PREFIX "")
target_link_libraries(${TARGET_NAME} PUBLIC bindings torch absl::strings ${TORCH_PYTHON_LIBRARY})
target_include_directories(${TARGET_NAME} PRIVATE ${PROJECT_SOURCE_DIR}/pytorch_helpers)
install(TARGETS ${TARGET_NAME} INCLUDES ${CMAKE_BINARY_DIR}/generated/env_flags/bridge_config.py LIBRARY
  DESTINATION habana_torch_plugin/internal)
add_dependencies(${TARGET_NAME} pytorch_generate_env)

add_custom_command(OUTPUT
${CMAKE_BINARY_DIR}/generated/env_flags/env_flags_generated.h
${CMAKE_BINARY_DIR}/generated/env_flags/env_flags_definition_generated.cpp
${CMAKE_BINARY_DIR}/generated/env_flags/Bindings.cpp
${PROJECT_SOURCE_DIR}/python_packages/habana_frameworks/torch/internal/bridge_config.py
COMMAND ${Python_EXECUTABLE} ${CMAKE_SOURCE_DIR}/scripts/generate_env.py
                     --output_dir=${CMAKE_BINARY_DIR}/generated/env_flags
                     --python_output_dir=${PROJECT_SOURCE_DIR}/python_packages/habana_frameworks/torch/internal
                     --yaml=${CMAKE_SOURCE_DIR}/scripts/env_flags.yaml
                   MAIN_DEPENDENCY ${CMAKE_SOURCE_DIR}/scripts/generate_env.py
                   DEPENDS
                     ${CMAKE_SOURCE_DIR}/scripts/env_flags.yaml
)
add_custom_target(pytorch_generate_env DEPENDS
  ${CMAKE_BINARY_DIR}/generated/env_flags/env_flags_generated.h
  ${CMAKE_BINARY_DIR}/generated/env_flags/env_flags_definition_generated.cpp
  ${CMAKE_BINARY_DIR}/generated/env_flags/Bindings.cpp
  ${PROJECT_SOURCE_DIR}/python_packages/habana_frameworks/torch/internal/bridge_config.py
)
